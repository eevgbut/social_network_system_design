# System Design социальной сети для курса по System Design

[Ссылка на курс](https://balun.courses/courses/system_design).

## FR

- добавление постов
  - с опциональной возможностью прикрепить гео-метку
  - с опциональной возможностью через аттач (скрепку) подгрузить фотографию
  - с обязательным заполнением описания поста
- оценивание постов 
  - оценки по шкале от 1 до 5
- комментирование постов без возможности подгрузки изображений
- подписка на других пользователей-путешественников через кнопку follow
  - с возможностью отменить и возобновить подписку произвольное кол-во раз
- ГЕО-раздел с популярными местами для путешествий 
  - в разделе отображаются топ-100 мест по популярности
  - есть возможность развернуть каждое место и увидеть список из постов из этих мест в хронологически убывающем порядке
- лента
  - в ленте отображаются посты других путешественников
  - как только пользователь "прокрутил" ленту до последней записи, загрузка выполняется еще раз
  - порядок обратный хронологический 
  - посты берутся из подписок

## NFR

- аудитория 10 000 000 уникальных пользователей ежедневно
- поведение пользователей
  - один пользователь в среднем будет публиковать 2 поста в неделю
  - один пользователь в среднем будет открывать ленту 10 раз в день и просматривать по 40 публикаций
  - 10 из 40-ка просмотренных публикаций пользователь будет оценивать
  - 1 из 40-ка просмотренных публикаций пользователь будет комментировать
  - в среднем каждую неделю пользователь будет подписываться на 3 новых профиля других пользователей и отписываться от 1-го
  - в среднем, пользователь будет просматривать гео-раздел 1 раза в день
- регионы использования приложения: страны СНГ
- в MVP взаимодействие с соц. сетью будет осуществляться только через мобильное приложение (через 2 года после запуска будет разработана web-версия для браузеров)
- сезонность
  - в период с апреля по июнь кол-во просмотренных публикаций составит `X2` от среднего
  - в период с июля по август кол-во публикацией составит `X6` от среднего
- все данные хранятся 5 лет, после чего публикации, комментарии, фото и оценки перемещаются в архивное хранилище
- лимиты
  - максимальное кол-во подписчиков одного пользователя – 1000000
  - длина текстового комментария от 1 до 1000 символов
  - длина текста в публикации от 1 до 2000 символов
  - максимальное кол-во фотографий на 1 публикацию – 10 штук
  - за один раз загружается не более чем 20 постов
- временные ограничения
  - публикация должна выполняться на более чем за 1,5 секунды (время от отправки запроса до получения ответа)
  - оценка должна выполняться за 1 с (время на реакцию мобильного приложения, возможно без синхронного запроса на сервер)
  - отправка комментария и подписка должна занимать не более 1 секунды
  - загрузка одной части ленты – 2 секунды
  - загрузка гео-раздела (с картой и метками-публикациями) – не более 3 секунд
- доступность приложения 99,95 (4,3 часа простоя в год)

## Расчет нагрузки

- RPS на публикацию: `10000000 пользователей * 2 поста в неделю / 7 дней в неделе / 86 400 = 33 RPS`
- RPS на ручку чтения публикаций: `10000000 пользователей * 10 открытий ленты в день * 2 загрузки батча публикаций (батч - 20 шт) / 86 400 = 2300 RPS`
- RPS на публикацию комментариев: `10000000 пользователей * 10 просмотров ленты в день * 1 комментирований / 86 400 = 1100 RPS`
- RPS на оценку публикацией: `10000000 пользователей * 10 просмотров ленты в день * 10 оцененных постов / 86 400 = 11500 RPS`
- RPS на подписки: `10000000 пользователей * (3 новых подписки + 1 отписка) / 7 дней в неделе / 86 400 = 66 RPS`
- RPS на чтение гео-раздела: `10000000 пользователей / 86 400 = 115 RPS`


- трафик на публикацию
  - на сохранение постов в relation db: `33 RPS * (текст 3 КБ + гео метка 100 байт) = 33 * 2400 = 100 КБ/с `
  - на сохранение фото в s3: `33 RPS * (≈8 фотографий по 300 кБ ≈2400 КБ) = 33 * 2400 = 80 МБ/с `
- трафик на чтение публикаций 
  - на получение постов из relation db `2300 RPS * (текст 3 КБ + гео метка 100 байт) = 6900 КБ/с = 6.5 МБ/с`
  - на подгрузка фото из s3: `2300 RPS * 2.4 МБ = 2300 * 2.4 = 1 ГБ/с `
- трафик на публикацию комментариев: `5787 RPS * (1000 символов кириллицы ≈1,5 КБ) = 5787 * 1,5 = 8,5 МБ/с `
- трафик на оценку публикацией не учитываем поскольку незначителен
- трафик на подписки не учитываем
- трафик на чтение гео-раздела (медиафайлов): `115 RPS * 50 МБ гео-данных = 6250 МБ/с = 6 ГБ/с`

- кол-во одновременных соединений `10 000 000 * 0.1 = 1000000`

## Оценка дисков

### Relational DB

```
Сapacity = 100 МБ/с \* 86 400 \* 365 = 3 ТБ
Disks_for_capacity = 3 ТБ / 2 ТБ = 1.5
Disks_for_throughput = 110 МБ/с / 100 МБ/с = 1.1
Disks_for_iops = 300 / 100 = 3
Disks = max(ceil(1.5), ceil(1.1), ceil(3)) = 3
```

### Blob storage

```
Сapacity = 100 МБ/с \* 86 400 \* 365 = 3 ТБ
Disks_for_capacity = 3 ТБ / 2 ТБ = 1.5
Disks_for_throughput = 110 МБ/с / 100 МБ/с = 1.1
Disks_for_iops = 300 / 100 = 3
Disks = max(ceil(1.5), ceil(1.1), ceil(3)) = 3
```